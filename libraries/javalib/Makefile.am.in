#
# Java core library component.
#
# Copyright (c) 1997, 1998, 1999
#      Transvirtual Technologies, Inc.  All rights reserved.
#
# Copyright (c) 2002, 2003, 2005
#      Kaffe.org contributors.
#
# See the file "license.terms" for information on usage and redistribution
# of this file.
#
# Class libraries are currently part of the integrate Make cycle. 
# Read FAQ/FAQ.classlibrary-compile for more information on the class library
# build process.
#
# Note: Makefile.am is generated from Makefile.am.in using 
# developers/update-class-list (called from developers/autogen.sh)
#
# Yes, it's slightly insane:
#
#   Makefile.am.in -> Makefile.am -> Makefile.in -> Makefile

# Only build the peerless AWT libraries if kaffe is configured to
# build the native libraries as well.
if COND_KAFFE_QT_AWT
MAYBE_PEERLESS_KAFFE_AWT=awt-implementations
else
if COND_KAFFE_X_AWT
MAYBE_PEERLESS_KAFFE_AWT=awt-implementations
endif
endif

# Only build gmp java.math libraries if kaffe is configured
# to build the native libraries as well.
if COND_PURE_JAVA_MATH
else
MAYBE_GMP_JAVA_MATH=gmp-math
endif

SUBDIRS = . $(MAYBE_PEERLESS_KAFFE_AWT) $(MAYBE_GMP_JAVA_MATH)

SRCDIRS = com gnu java javax kaffe org

## taken from top level Makefile.am
JAVA=$(top_builddir)/kaffe/kaffe/kaffe-bin$(EXEEXT)
KAFFELIBRARYPATH=$(top_builddir)/libraries/clib/native/:$(top_builddir)/libraries/clib/io/:$(top_builddir)/libraries/clib/zip/:$(top_builddir)/libraries/clib/nio/:$(top_builddir)/libraries/clib/security/:$(top_builddir)/libraries/clib/classpath/
BOOTCLASSPATH=$(LIBDIR):$(srcdir)/Klasses.jar.bootstrap
JAR=BOOTCLASSPATH=$(BOOTCLASSPATH) KAFFELIBRARYPATH=$(KAFFELIBRARYPATH) $(JAVA) kaffe.tools.jar.Jar

installed_properties = \
	logging.properties

jrelib_DATA = \
	rt.jar \
	$(installed_properties)

Klasses_jar_SRCS = \
	# The following will be replaced by the
	# developers/update-class-list script with a
	# list of the packages and classes we want
	# to build


## Do not delete the previous blank line; update-class-list depends on it

serialized_converters = \
	kaffe/io/ByteToChar8859_2.ser \
	kaffe/io/ByteToChar8859_3.ser \
	kaffe/io/ByteToChar8859_4.ser \
	kaffe/io/ByteToChar8859_5.ser \
	kaffe/io/ByteToChar8859_6.ser \
	kaffe/io/ByteToChar8859_7.ser \
	kaffe/io/ByteToChar8859_8.ser \
	kaffe/io/ByteToChar8859_9.ser \
	kaffe/io/ByteToCharASCII.ser \
	kaffe/io/ByteToCharCP037.ser \
	kaffe/io/ByteToCharCP1026.ser \
	kaffe/io/ByteToCharCP1046.ser \
	kaffe/io/ByteToCharCP1250.ser \
	kaffe/io/ByteToCharCP1251.ser \
	kaffe/io/ByteToCharCP1252.ser \
	kaffe/io/ByteToCharCP1253.ser \
	kaffe/io/ByteToCharCP1254.ser \
	kaffe/io/ByteToCharCP1255.ser \
	kaffe/io/ByteToCharCP1256.ser \
	kaffe/io/ByteToCharCP1257.ser \
	kaffe/io/ByteToCharCP1258.ser \
	kaffe/io/ByteToCharCP850.ser \
	kaffe/io/ByteToCharCP852.ser \
	kaffe/io/ByteToCharCP855.ser \
	kaffe/io/ByteToCharCP857.ser \
	kaffe/io/ByteToCharCP860.ser \
	kaffe/io/ByteToCharCP861.ser \
	kaffe/io/ByteToCharCP862.ser \
	kaffe/io/ByteToCharCP863.ser \
	kaffe/io/ByteToCharCP864.ser \
	kaffe/io/ByteToCharCP865.ser \
	kaffe/io/ByteToCharCP866.ser \
	kaffe/io/ByteToCharCP868.ser \
	kaffe/io/ByteToCharCP869.ser \
	kaffe/io/ByteToCharCP870.ser \
	kaffe/io/ByteToCharCP871.ser \
	kaffe/io/ByteToCharCP875.ser \
	kaffe/io/ByteToCharCP918.ser \
	kaffe/io/ByteToCharKOI8_R.ser \
	kaffe/io/CharToByte8859_2.ser \
	kaffe/io/CharToByte8859_3.ser \
	kaffe/io/CharToByte8859_4.ser \
	kaffe/io/CharToByte8859_5.ser \
	kaffe/io/CharToByte8859_6.ser \
	kaffe/io/CharToByte8859_7.ser \
	kaffe/io/CharToByte8859_8.ser \
	kaffe/io/CharToByte8859_9.ser \
	kaffe/io/CharToByteASCII.ser \
	kaffe/io/CharToByteCP037.ser \
	kaffe/io/CharToByteCP1026.ser \
	kaffe/io/CharToByteCP1046.ser \
	kaffe/io/CharToByteCP1250.ser \
	kaffe/io/CharToByteCP1251.ser \
	kaffe/io/CharToByteCP1252.ser \
	kaffe/io/CharToByteCP1253.ser \
	kaffe/io/CharToByteCP1254.ser \
	kaffe/io/CharToByteCP1255.ser \
	kaffe/io/CharToByteCP1256.ser \
	kaffe/io/CharToByteCP1257.ser \
	kaffe/io/CharToByteCP1258.ser \
	kaffe/io/CharToByteCP850.ser \
	kaffe/io/CharToByteCP852.ser \
	kaffe/io/CharToByteCP855.ser \
	kaffe/io/CharToByteCP857.ser \
	kaffe/io/CharToByteCP860.ser \
	kaffe/io/CharToByteCP861.ser \
	kaffe/io/CharToByteCP862.ser \
	kaffe/io/CharToByteCP863.ser \
	kaffe/io/CharToByteCP864.ser \
	kaffe/io/CharToByteCP865.ser \
	kaffe/io/CharToByteCP866.ser \
	kaffe/io/CharToByteCP868.ser \
	kaffe/io/CharToByteCP869.ser \
	kaffe/io/CharToByteCP870.ser \
	kaffe/io/CharToByteCP871.ser \
	kaffe/io/CharToByteCP875.ser \
	kaffe/io/CharToByteCP918.ser \
	kaffe/io/CharToByteKOI8_R.ser

gnu_regexp_message_bundles = \
	gnu/regexp/MessagesBundle_fr.properties \
	gnu/regexp/MessagesBundle_it.properties \
	gnu/regexp/MessagesBundle.properties

gnu_getopt_message_bundles = \
	gnu/getopt/MessagesBundle_cs.properties \
       	gnu/getopt/MessagesBundle_ja.properties \
	gnu/getopt/MessagesBundle_de.properties \
       	gnu/getopt/MessagesBundle_nl.properties \
	gnu/getopt/MessagesBundle_fr.properties \
       	gnu/getopt/MessagesBundle_no.properties \
	gnu/getopt/MessagesBundle_hu.properties \
       	gnu/getopt/MessagesBundle.properties

classpath_resources = \
	java/util/iso4217.properties

EXTRA_DIST = \
	Makefile.am.in \
	META-INF \
	com \
	gnu \
	java \
	javax \
	kaffe \
	org \
	all.files \
        bootstrap.classlist \
	$(OMITTED_PACKAGES_SRCS) \
	$(serialized_converters) \
	$(gnu_regexp_message_bundles) \
	$(gnu_getopt_message_bundles) \
	$(installed_properties)

dist-hook:
	rm -rf `find $(distdir) -name CVS`
	rm -rf `find $(distdir) -name *~`

LIBDIR = lib

clean-local:
	-rm -rf $(LIBDIR) rt.jar

.PHONY: new-classes
new-classes: $(top_srcdir)/developers/update-class-list
	cd $(srcdir) && $(SHELL) $(top_srcdir)/developers/update-class-list

rebuildLib = ./rebuildLib

.PHONY: compile-classes classes
## classes is provided for backward compatibility; use compile-classes
compile-classes $(LIBDIR)/stamp classes: $(rebuildLib) $(Klasses_jar_SRCS)
	rm -rf $(LIBDIR)
	mkdir $(LIBDIR)
	if test "$(PROFILE)" = default; then \
		$(SHELL) $(rebuildLib) @all.files; \
	else \
		$(SHELL) $(rebuildLib) @$(PROFILE); \
	fi
	echo timestamp > $(LIBDIR)/stamp

bootstrap: $(srcdir)/Klasses.jar.bootstrap
$(srcdir)/Klasses.jar.bootstrap: rt.jar
	rm -f $@.new
if HAVE_ZIP
	(cd $(LIBDIR) && $(ZIP) -DX -r $(CURDIR)/$@.new `grep '\.class$$' $(abssrcdir)/libraries/javalib/bootstrap.classlist`)
else
	$(JAR) -cf $@.new -C $(LIBDIR) `grep '\.class$$' $(abssrcdir)/libraries/javalib/bootstrap.classlist`
endif
	mv $@.new $@

.PHONY: bootstrap
$(srcdir)/Klasses.jar.bootstrap: bootstrap.classlist

if HAVE_ZIP
JAR_CMD1 = (cd $(srcdir) && $(ZIP) -q -r $(CURDIR)/$@.new META-INF)
JAR_CMD2 = (cd $(LIBDIR) && $(ZIP) -q -DX -r $(CURDIR)/$@.new $(SRCDIRS))
JAR_CMD3 = (cd $(srcdir) && $(ZIP) -q -DX -r $(CURDIR)/$@.new $(gnu_regexp_message_bundles))
JAR_CMD4 = (cd $(srcdir) && $(ZIP) -q -DX -r $(CURDIR)/$@.new $(serialized_converters))
JAR_CMD5 = (cd $(srcdir) && $(ZIP) -q -DX -r $(CURDIR)/$@.new $(gnu_getopt_message_bundles))
JAR_CMD6 = (cd $(srcdir) && $(ZIP) -q -DX -r $(CURDIR)/$@.new $(classpath_resources))

else
JAR_CMD1 = $(JAR) -cf $@.new -C $(LIBDIR) $(SRCDIRS)
JAR_CMD2 = $(JAR) -uf $@.new -C $(srcdir) META-INF/
JAR_CMD3 = $(JAR) -uf $@.new -C $(srcdir) $(gnu_regexp_message_bundles)
JAR_CMD4 = $(JAR) -uf $@.new -C $(srcdir) $(serialized_converters)
JAR_CMD5 = $(JAR) -uf $@.new -C $(srcdir) $(gnu_getopt_message_bundles)
JAR_CMD6 = $(JAR) -uf $@.new -C $(srcdir) $(classpath_resources)
endif

.PHONY: jar-classes
if USE_PRECOMPILED_RT_JAR
jar-classes: rt.jar
rt.jar: $(PATH_TO_RT_JAR)
	cp $< $@
else
jar-classes: rt.jar
rt.jar: $(LIBDIR)/stamp $(Klasses_jar_SRCS)
	rm -f rt.jar
	$(JAR_CMD1)
	$(JAR_CMD2)
	$(JAR_CMD3)
	$(JAR_CMD4)
	$(JAR_CMD5)
	$(JAR_CMD6)
	mv $@.new $@
endif

.PHONY: build-classes Klasses
build-classes Klasses: rt.jar

all-am: rebuildLib
export JIKES top_builddir LIBDIR srcdir
